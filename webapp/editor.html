<!DOCTYPE html>
<html>
<head>
    <title>4DK SCADA Diagram Editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styles/parameter-mapping.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #editor-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: #666;
            font-size: 16px;
        }

        .scada-toolbar {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 9999;
            display: none;
        }

        .scada-toolbar.visible {
            display: block;
        }

        .scada-toolbar button {
            padding: 8px 16px;
            margin: 0 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .scada-toolbar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading SCADA Diagram Editor...</div>
    </div>

    <div class="scada-toolbar" id="scadaToolbar">
        <button onclick="openParameterMapping()">Add Parameter Mapping</button>
        <button onclick="viewMappings()">View Mappings</button>
        <button onclick="showHelp()">Help</button>
    </div>

    <iframe
        id="editor-frame"
        src="https://embed.diagrams.net/?embed=1&ui=kennedy&spin=1&proto=json&configure=1"
        allow="fullscreen"
    ></iframe>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-integration.js"></script>

    <script>
        let editorFrame = null;
        let currentDiagram = null;
        let parameterMappings = {};

        window.addEventListener('load', function() {
            editorFrame = document.getElementById('editor-frame');

            // Hide loading overlay after iframe loads
            editorFrame.addEventListener('load', function() {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    document.getElementById('scadaToolbar').classList.add('visible');
                }, 1000);
            });

            // Listen for messages from the iframe
            window.addEventListener('message', function(event) {
                if (event.data.length > 0) {
                    try {
                        const msg = JSON.parse(event.data);
                        handleEditorMessage(msg);
                    } catch (e) {
                        // Ignore non-JSON messages
                    }
                }
            });
        });

        function handleEditorMessage(msg) {
            if (msg.event === 'init') {
                console.log('Editor initialized');
            } else if (msg.event === 'save') {
                currentDiagram = msg.xml;
                console.log('Diagram saved');
            } else if (msg.event === 'export') {
                handleExport(msg.data);
            }
        }

        function sendMessageToEditor(action, data) {
            editorFrame.contentWindow.postMessage(JSON.stringify({
                action: action,
                ...data
            }), '*');
        }

        function openParameterMapping() {
            alert('To add parameter mapping:\n\n' +
                  '1. Draw or select a shape in the editor\n' +
                  '2. Right-click and select "Edit Data"\n' +
                  '3. Add custom properties:\n' +
                  '   - scada-param: YOUR_PARAMETER_NAME\n' +
                  '   - scada-type: gradient-level (or text/fill-color/stroke-color)\n' +
                  '   - scada-min: 0\n' +
                  '   - scada-max: 100\n' +
                  '   - scada-direction: bottom-to-top\n' +
                  '4. Export as SVG\n\n' +
                  'See documentation for more details!');
        }

        function viewMappings() {
            const mappingsList = Object.keys(parameterMappings).length > 0
                ? Object.keys(parameterMappings).join(', ')
                : 'No mappings yet';

            alert('Current Parameter Mappings:\n\n' + mappingsList + '\n\n' +
                  'Add mappings using "Edit Data" on shapes.');
        }

        function showHelp() {
            window.open('INSTALLATION_GUIDE.md', '_blank');
        }

        // Export handler
        function handleExport(data) {
            if (data && data.indexOf('<svg') !== -1) {
                // Process SVG export
                console.log('SVG exported, ready for parameter mapping');
            }
        }
    </script>
</body>
</html>
